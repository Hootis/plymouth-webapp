<?php
ob_start();
$page_title = "AJAX";
$template_file = TEMPLATE_DIR."/ajax_backend.tpl";
$tpl = new XTemplate($template_file);
$tpl->assign('call_log_web_home', CALL_LOG_WEB_HOME);
$tpl->assign('calllog_user_name', $_SESSION['username']);

error_reporting(E_ALL ^ E_NOTICE); 
$ajax = ($_SERVER['HTTP_X_REQUESTED_WITH'] == 'XMLHttpRequest'||$_GET['ajax']==1) ? true : false;

switch($_GET['return']) {

    case 'knowledgebase_data':
		if($ajax) {
			if ($_GET['searchterm'] != ''){
				$links = $db->GetAll("SELECT id, cms_path, title, MATCH(title, content) AGAINST ('{$_GET['searchterm']}') AS relevance FROM cache_help WHERE MATCH(title, content) AGAINST ('{$_GET['searchterm']}') HAVING relevance > 0 ORDER BY relevance DESC LIMIT 5");

				if($links!==false){
					foreach($links as $i=>$link){
						$link['url'] = str_replace('www/','http://www.plymouth.edu/',$link['cms_path']);
						$tpl->assign('link', $link);

						$link['title'] = substr($link['title'],0,35)."...";

						$sql = "SELECT COUNT(*) FROM knowledgebase_emails WHERE caller_user_name = '{$_GET['caller_user_name']}' AND kb_article = '{$link['id']}'";
						$count_sent = $db->GetOne($sql);

						$tpl->assign('i', $i);
						$tpl->assign('count_sent', $count_sent);
						if ($count_sent > 0){
							$tpl->parse('main.kb.sent');
						}else{
							$tpl->parse('main.kb.none');
						}

						$tpl->parse('main.kb.link');
					}
				}
				else{
					$tpl->parse("main.kb.no_results");
				}
			}
			else{
				$tpl->parse("main.kb.view");
			}

			$tpl->parse('main.kb');
			$tpl->parse('main');
			$tpl->out('main');
		}
	break;
	
    case 'sendKBEmail':
		if($ajax) {
			$now = date("Y-m-d G:i:s");

			$KBArticle = $db->GetOne("SELECT content FROM cache_help WHERE id = '{$_GET['KBArticle']}'");

			// To send HTML mail, the Content-type header must be set
			$headers  = 'MIME-Version: 1.0' . "\r\n";
			$headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";

			// Additional headers
			$headers .= "To: ".$_GET['caller_user_name']."@plymouth.edu" . "\r\n";
			$headers .= "From: ITS Help Desk <helpdesk@plymouth.edu>" . "\r\n";
			$ITSHeaderMessage = "<b>This message has been auto-generated by the ITS Help Desk and contains an article about the information you requested.</b><br/><br/>";
			$ITSFooterMessage = "<br/><b>If you have other questions, you can visit the \"Help Tab\" in myPlymouth</b>";

			mail($to, 'ITS Helpdesk Article', $ITSHeaderMessage.$KBArticle.$ITSFooterMessage, $headers);

			//Insert into database for logging
			$InsertIntoDatabase = $db->Execute("INSERT INTO knowledgebase_emails (id, caller_user_name, kb_article, date_time, calllog_user_name) VALUES ('','$_GET[caller_user_name]', '$_GET[KBArticle]', '$now', '$_SESSION[username]')");
			//End Insert into database for logging
		}
	break;

	case 'autoSaveCall':
		if($ajax){
			$get_recovered_data_query = $db->GetRow("SELECT * FROM temp_call WHERE call_log_username = '$_SESSION[username]' ORDER BY recovery_data DESC LIMIT 1");
			$get_recovered_data = unserialize($get_recovered_data_query['recovery_data']);
			if($_GET['call_details'] != ""){
				if($get_recovered_data['call_details'] != $_GET['call_details']){
					$recovery_data = array();
					$recovery_data['call_log_username'] = $_SESSION['username'];
					$recovery_data['caller_user_name'] = $_GET['caller_user_name'];
					$recovery_data['call_details'] = $_GET['call_details'];
					$recovery_data['call_date'] = $today;
					$recovery_data['call_time'] = $time;
					$recovered_data = serialize($recovery_data);
					$recovered_insert = $db->Execute("INSERT INTO temp_call (call_log_username, recovery_data) VALUES ('$_SESSION[username]', '$recovered_data')");
					echo "Temp. Saved on $today at $time";
				}else{
					echo "Temp. Saved on ".$get_recovered_data['call_date']." at ".$get_recovered_data['call_time'];
				}
			}else{
				echo "Auto Save Every 30 Seconds";
			}
		}
	break;

	case 'deleteSavedData':
		if($ajax){
			$recovered_insert = $db->Execute("DELETE FROM temp_call WHERE call_log_username = '$_SESSION[username]'");
		}
	break;

	case 'showGroupUsers':
		if($ajax){
			$getGroupUsers = $db->GetAll("SELECT * FROM its_employee_groups, call_log_employee WHERE its_employee_groups.group_id = '$_GET[group_number]' AND call_log_employee.call_log_user_id = its_employee_groups.employee_id AND its_employee_groups.option_id != '0'");
			for($i=0;$i<=count($getGroupUsers);$i++){
				$j = $i+1;
				$group_names = $j." - ".$getGroupUsers[$i]['first_name']." ".$getGroupUsers[$i]['last_name']."<br/>";
				$tpl->assign('group_names',$group_names);
				$tpl->parse('main.group_names');
			}
			$tpl->parse('main');
			$tpl->out('main');
		}
	break;

    case 'keywordList':
		if($ajax) {
			ob_clean();
			echo generateKeywordList($_GET['call_id'], $_GET['details']);
		}
	break;

	case 'get_employee_group_info':
		if($ajax){
			if(function_exists("displayOpenCalls")){
				$level = ".displayOpenCalls";
				$tpl->assign('displayOpenCalls', displayOpenCalls($template_file, $level));
				$tpl->parse('main'.$level);
				$tpl->parse('main');
				$tpl->out('main');
			}
		}
	break;

    case 'searchResults':
		if($ajax) {
			if($_GET['type']) {
				$_GET['search_type'] = $_GET['type'];
			}
			
			if(in_array($_GET['search_type'], $phonebook_search)) {
				$search_results = phonebookSearch($_GET['search_string'], $_GET['search_type']);
			}
			
			$_SESSION['search_string'] = $_GET['search_string'];
			$_SESSION['search_type'] = $_GET['search_type'];
			
			switch($_GET['search_type']) {
				case 'closed':
					$results = $db->GetAll("SELECT * FROM call_view WHERE caller_username = ".$db->qstr($_GET['search_string'])." AND current='1' AND call_status = 'closed' ORDER BY call_date DESC, call_time DESC");
					foreach($results as $key) {
						$key['comments'] = substr($key['comments'],0,23).'...';
						$tpl->assign('key', $key);
						$tpl->assign('search_string', $_GET['search_string']);
						$tpl->assign('search_type', $_GET['search_type']);
						$tpl->parse('main.searchResults.user_closed_calls');
					}
	
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'Call ID');
					$tpl->assign('search_field_2', 'Name');
					$tpl->assign('search_field_3', 'Call Date');
					$tpl->assign('search_field_4', 'Call Time');
					$tpl->assign('search_field_5', 'Comments');
					$tpl->assign('search_results_text', "Calls By");	
				break;
				case 'computer':
					$hardware = searchHardwareInformation($_GET['search_string']);
					$username = explode("@", $hardware[0]['email']);
					$username = $username[0];
					foreach ($hardware as $hardware_info){
						$tpl->assign('HW_Key', $hardware_info['id']);
						$tpl->assign('HW_IPName', $hardware_info['computer_name']);
						$tpl->assign('HW_Username', $username);
						$tpl->assign('MACAddress', $hardware_info['mac_address']);
						$tpl->assign('IPAddress', $hardware_info['ip_address']);
						$tpl->assign('search_string', $_GET['search_string']);
						$tpl->assign('location', $hardware_info['NodeName']);
						$tpl->assign('search_type', $_GET['search_type']);
						$tpl->parse('main.searchResults.hardware_info');
					}
					
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'Computer Name');
					$tpl->assign('search_field_2', 'MAC Address');
					$tpl->assign('search_field_3', 'IP Address');
					$tpl->assign('search_field_4', 'Location');
					$tpl->assign('search_results_text', 'Computer Name');
				break;
				case 'ip':
					$HardwareInfo = $db->GetAll("SELECT * FROM hardware_inventory WHERE ip_address = ?", array($_GET['search_string']));
					$username = explode("@", $HardwareInfo[0]['email']);
					$username = $username[0];
					$search_results = phonebookSearch($username);
					$search_results = current($search_results);
					$tpl->assign('HW_Key', $HardwareInfo[0]['id']);
					$tpl->assign('HW_IPName', $HardwareInfo[0]['computer_name']);
					$tpl->assign('HW_Username', $search_results['email']);
					$tpl->assign('HW_Name', $search_results['name_full']);
					$tpl->assign('MACAddress', $HardwareInfo[0]['mac_address']);
					$tpl->assign('IPAddress', $HardwareInfo[0]['ip_address']);
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->parse('main.searchResults.hardware_info_IP');
	
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'IP Address');
					$tpl->assign('search_field_2', 'Name');
					$tpl->assign('search_field_3', 'Username');
					$tpl->assign('search_field_4', 'MAC Address');
					$tpl->assign('search_field_5', 'Computer Name');
					$tpl->assign('search_results_text', 'IP Address');
				break;
				case 'mac':
					$HardwareInfo = $db->GetAll("SELECT * FROM hardware_inventory WHERE upper(mac_address) = ?", array(strtoupper($_GET['search_string'])));
					$username = explode("@", $HardwareInfo[0]['email']);
					$username = $username[0];
					$search_results = phonebookSearch($username);
					$search_results = current($search_results);
					$tpl->assign('HW_Key', $HardwareInfo[0]['id']);
					$tpl->assign('HW_IPName', $HardwareInfo[0]['computer_name']);
					$tpl->assign('HW_Username', $search_results['email']);
					$tpl->assign('HW_Name', $search_results['name_full']);
					$tpl->assign('MACAddress', $HardwareInfo[0]['mac_address']);
					$tpl->assign('IPAddress', $HardwareInfo[0]['ip_address']);
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->parse('main.searchResults.hardware_info_MAC');
	
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'MAC Address');
					$tpl->assign('search_field_2', 'Name');
					$tpl->assign('search_field_3', 'Username');
					$tpl->assign('search_field_4', 'Computer Name');
					$tpl->assign('search_field_5', 'IP Address');
					$tpl->assign('search_results_text', 'MAC Address');		
				break;
				case 'ticket':
					$ticket_number_results = searchTicketNumber($_GET['search_string']);
					if ($ticket_number_results['call_id'] != '')
					{
						$tpl->assign('call_id', $ticket_number_results['call_id']);
						$tpl->assign('caller_username', $ticket_number_results['caller_username']);
						$tpl->assign('caller_first_name', $ticket_number_results['caller_first_name']);
						$tpl->assign('caller_last_name', $ticket_number_results['caller_last_name']);
						$tpl->assign('caller_phone_number', $ticket_number_results['caller_phone_number']);
						$tpl->assign('call_date', $ticket_number_results['call_date']);
						$tpl->assign('call_time', $ticket_number_results['call_time']);
						$tpl->assign('calllog_username', $ticket_number_results['calllog_username']);
						$tpl->assign('search_string', $_GET['search_string']);
						$tpl->assign('search_type', $_GET['search_type']);
						$tpl->parse('main.searchResults.ticket_info');
						$tpl->assign($_GET['search_type'].'_selected', 'SELECTED');
					}
					else
					{
						$tpl->assign('no_ticket', 'NO TICKET FOUND');
						$tpl->parse('main.searchResults.no_ticket');
					}
					$tpl->assign('search_field_1', 'Call ID');
					$tpl->assign('search_field_2', 'Name');
					$tpl->assign('search_field_3', 'Username');
					$tpl->assign('search_field_4', 'Call Date/Time');
					$tpl->assign('search_field_5', 'Call Log User');
					$tpl->assign('search_results_text', 'Ticket #');
				break;
				case 'user':
					$results = $db->GetAll("SELECT * FROM call_log, call_history WHERE call_log.call_id = call_history.call_id AND call_log.calllog_username = '$_GET[search_string]' AND current='1' ORDER BY call_date DESC, call_time DESC");
					foreach($results as $key){
						if($key['comments'] != ""){
							$key['comments'] = substr($key['comments'],0,23).'...';
						}else{
							$key['comments'] = "Closed on Submit";
						}
						$tpl->assign('key', $key);
						$tpl->assign('search_string', $_GET['search_string']);
						$tpl->assign('search_type', $_GET['search_type']);
						$tpl->parse('main.searchResults.call_log_user');
					}
	
					$tpl->assign('search_string', $_GET['search_string']);
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'Call ID');
					$tpl->assign('search_field_2', 'Name');
					$tpl->assign('search_field_3', 'Call Date');
					$tpl->assign('search_field_4', 'Call Time');
					$tpl->assign('search_field_5', 'Comments');
					$tpl->assign('search_results_text', "Calls By");
				break;
				case 'wp_id':
				case 'all':
				case 'name_last':
				case 'name_first':
				case 'email':
				case 'phone':
					if( $_GET['search_type'] == 'wp_id' ) {
						$search_results = PSU::db('connect')->GetAll("SELECT * FROM wp_users WHERE user_login LIKE ?", array( $_GET['search_string'].'%' ));
						foreach( $search_results as &$record ) {
							$person = new PSUPerson( $record['user_login'] );
							$record['identifier'] = $record['wp_id'] = $person->wp_id;
							$record['name_full'] = $person->formatName('f m l');
							$record['email'] = $person->username;
							$record['dept'] = 'Family Portal';
							$person->destroy();
							unset($person);
						}//end foreach
					}//end if

					$_GET['search_type'] = $_GET['search_type'].$_GET['type'];
					foreach($search_results as $k=>$key) {
						$class_prepend = '';
						
						if($key['email']) {
							$display = "user_info";

							if( !$key['identifier'] ) {
								$key['identifier'] = $key['email'];
							}//end if
						}//end if
						else {
							$display = "no_username";

							if( !$key['identifier'] ) {
								$key['identifier'] = $key['pidm'];
							}//end if
						}//end else
						
						$portal_roles = $GLOBALS['portal']->getRoles($key['email']);
						if(is_array($portal_roles) && in_array('alumni',$portal_roles)) {
							$class_prepend = 'Alumni'.(($class_prepend)? '/ '.$class_prepend : '');
						}//end if
						
						if(is_array($portal_roles) && in_array('student_account_active',$portal_roles)) {
							$class_prepend = 'Student'.(($class_prepend)? '/ '.$class_prepend : '');
						}//end if
						
						$key['dept'] = $class_prepend.(($key['dept'])? '/ '.$key['dept'] : '');

						if( $key['pidm'] || $key['username'] || $key['wp_id'] ) {
							$where = array();
							$args = array();

							if( $key['pidm'] ) {
								$where[] = "call_log.pidm = ?";
								$args[] = $key['pidm'];
							}//end if

							if( $key['username'] ) {
								$where[] = "call_log.caller_username = ?";
								$args[] = $key['username'];
							}//end if

							if( $key['wp_id'] ) {
								$where[] = "call_log.wp_id = ?";
								$args[] = $key['wp_id'];
							}//end if

							$where = implode(" OR ", $where);
							
							$getOpenCallInfo = $db->GetOne("SELECT * FROM call_log, call_history WHERE call_log.call_id = call_history.call_id AND call_history.call_status = 'open' AND ({$where}) AND call_history.current='1'", $args);
							
							$num_open_calls = $db->GetOne("SELECT count(*) FROM call_log, call_history WHERE call_log.call_id = call_history.call_id AND call_history.call_status = 'open' AND ({$where}) AND call_history.current='1'", $args);
							if ($num_open_calls >= 1) {
								$key['call_id'] = $getOpenCallInfo;
								$key['open_call'] = "(".$num_open_calls." Open)";
								$tpl->parse('main.open_call_alert');
							}//end if

							if ($key['major'] && $key['title']){
								$key['major_title'] = substr($key['major'].' / '.$key['title'], 0, 20);
								$key['major_title_full'] = $key['major'].' / '.$key['title'];
							}else{
								$key['major_title'] = substr($key['major'].' '.$key['title'], 0, 20);
								$key['major_title_full'] = $key['major'].' '.$key['title'];
							}//end else
						}//end if
	
						$tpl->assign('search_type', $_GET['search_type']);
						$tpl->assign('search_string', $_GET['search_string']);
						$tpl->assign('key', $key);
						$tpl->parse('main.searchResults.results.'.$display);
						$tpl->parse('main.searchResults.results');
					}// end foreach

					$tpl->assign('search_string', stripslashes($_GET['search_string']));
					$tpl->assign('search_type', $_GET['search_type']);
					$tpl->assign('search_field_1', 'Name');
					$tpl->assign('search_field_2', 'Username');
					$tpl->assign('search_field_3', 'Phone');
					$tpl->assign('search_field_4', 'Major/Title');
					$tpl->assign('search_field_5', 'Class/Dept');
	
					switch($_GET['search_type']) {
						case 'email':
							$tpl->assign('search_results_text', "User Name");
							$tpl->assign('five_selected', 'SELECTED');						
						break;
						case 'name_last':
							$tpl->assign('search_results_text', "Last Name");
							$tpl->assign('2_selected', 'SELECTED');
						break;
						case 'name_first':
							$tpl->assign('search_results_text', "First Name");
							$tpl->assign('1_selected', 'SELECTED');
						break;
					}//end switch
				break;
				default:
					$tpl->parse('main.searchResults.no_results_message');
				break;
			}//end switch
		}else if (($_GET['search_type'] == '') && ($_GET['search_string'] != '')){
			echo '<h2>Bad search type.</h2>';
		}else{
			$tpl->assign('search_field_1', 'Name');
			$tpl->assign('search_field_2', 'Username');
			$tpl->assign('search_field_3', 'Phone');
			$tpl->assign('search_field_4', 'Major/Title');
			$tpl->assign('search_field_5', 'Dept/Class');
		}
		$tpl->parse('main.searchResults');
		$tpl->parse('main');
		$tpl->out('main');
	break;

	case 'addAttachments':
		$file_name = $_POST['attachment_file_name'];
		$file = $_FILES['attachment_file'];
		$the_file = 
		//$the_file = PHOTO_UPLOAD_DIR.'/jjrennie.gif'; //Testing File
		$fileSize = filesize($the_file);
		$fileHandle = fopen($the_file, "r");
		$fileContent = addslashes(fread($fileHandle, $fileSize));
		$_SESSION['attachment_ids'] = array();
		if($file['error'] == 0){
			if($_GET['call_id'] != ""){
				$insertFile = $db->query("INSERT INTO attachments (call_id, file_name, attachment, type) VALUES ('{$_GET['call_id']}','{$file_name}','{$fileContent}', '{$file['type']}')");
			}else{
				$_SESSION['update_attachments'] = 'yes';
				$insertFile = $db->query("INSERT INTO attachments (call_id, file_name, attachment, type) VALUES ('','{$file_name}','{$fileContent}', '{$file['type']}')");
				$return_call_id = $db->Insert_ID();
				$_SESSION['attachment_ids'] .= array($return_call_id);
				prePrint($_SESSION);
			}
			$get_files = $db->GetAll("SELECT * FROM attachments WHERE call_id = '{$_GET['call_id']}'");
			for($i=0;$i<count($get_files);$i++){
				$j = $i+1;
				echo $j.". ".$get_files[$i]['file_name']."<br/>";
			}
		}
	break;

	case 'showAttachments':
		
		$get_files = $db->GetRow("SELECT * FROM attachments WHERE attach_id = {$_GET['attach_id']}");
		header("Content-type: {$get_files['type']}");
		echo $get_files['attachment'];

	break;

	case 'openCalls': 
		if($ajax) {
			$result = returnOpenCalls($_GET['option'], $_GET['group'], $_GET['sort_by']);
			$i = 0;
			$tpl->assign('GET', $_GET);
			if(!empty($result) && is_array($result)){

				$call_open_time = array();

				foreach($result as $key => $row){
					$groupArray = getGroupInfo($row['its_assigned_group']);
					$row['building_name'] = getBuildingName($row['location_building_id']);
					if (($row['its_assigned_group'] != 0) || ($groupArray[1] != "")){
						if($row['tlc_assigned_to'] != 'unassigned'){
							$row['assigned_to'] = $groupArray[1]."_group, ".$row['tlc_assigned_to'];
						}else{
							$row['assigned_to'] = $groupArray[1]."_group";
						}
					}else if($row['tlc_assigned_to'] != ""){
						$row['assigned_to'] = $row['tlc_assigned_to'];
					}else{
						$row['assigned_to'] = "None";
					}
					$row['call_title'] = $row['title'];
					$row['call_summary'] = substr($row['comments'],0,100).((strlen($row['comments'])>100)?'...':'').' -'.$row['updated_by'].' @'.date('M j, y g:ia',strtotime($row['date_assigned'].' '.$row['time_assigned']));
					$row['show_comments'] = str_replace("\"", "&#34",addslashes(substr(strip_tags(str_replace(array("\n","\t","\r"),'',$row['comments'])),0,30)));

					$call_datetime = $row['call_date'].' '.$row['call_time'];
					$call_open_time[$row['call_id']] = time() - strtotime($call_datetime);
					$row['call_date'] = date('M j, Y', strtotime($call_datetime));
					$row['call_time'] = date('g:i a', strtotime($call_datetime));
					if( $row['feelings_face'] ) {
						$row['feelings_face'] = '<br/><img src="/webapp/feedback/templates/images/feedback-'.$row['feelings_face'].'.png" class="feedback-face" title="'.$row['feelings'].'"/>';
					}//end if

					if($row['date_assigned'])
					{
						$assign_datetime = $row['date_assigned'].' '.$row['time_assigned'];
						$row['activity_datetime'] = time() - strtotime($assign_datetime);
						$row['date_assigned'] = date('M j, Y', strtotime($assign_datetime));
						$row['time_assigned'] = date('g:i a', strtotime($assign_datetime));
					}//end if

					// If the time that the call has been open (call_open_time) is greater than one week (604800 seconds)
					if ($call_open_time[$row['call_id']] > 604800) {
						// Set a call age status variable and mark it as old
						$row['call_age_status'] = 'old';
					}
					else {
						// Otherwise, mark it as normal
						$row['call_age_status'] = 'normal';
					}

					// If the time since the call has been updated (activity_datetime) is greater than one week (604800 seconds)
					if ($row['activity_datetime'] > 604800) {
						// Set an activity  age status variable and mark it as old
						$row['activity_age_status'] = 'old';
					}
					else {
						// Otherwise, mark it as normal
						$row['activity_age_status'] = 'normal';
					}

					$identifier = PSU::nvl($row['caller_username'], $row['wp_id'], $row['pidm']);

					$row = array_merge($row, (array) $GLOBALS['user']->getCallerData( $identifier ));
					$tpl->assign('row', $row);
					$tpl->parse('main.open_calls.open_calls_table.open_call_details.assigned_open_call');
					$priority = $call_details['call_history'][$i]['call_priority'];
					$tpl->assign('open_call_type', $_GET['open_call_type']);
					$tpl->assign('group_number', $_GET['group']);
					$tpl->assign('open_call_option', $_GET['option']);
					$tpl->parse('main.open_calls.open_calls_table.open_call_details');
					$i++;
				}// end foreach
				if(count($call_open_time)) {
					$average = array_sum($call_open_time)/count($call_open_time);
				}//end if
				else {
					$average = 0;
				}//end else
				$average = PSU::seconds_to_time($average);
				$average_string = '';
				if($average['years']) $average_string .= $average['years'].' years ';
				if($average['days']) $average_string .= $average['days'].' days ';
				if($average['hours']) $average_string .= $average['hours'].' hours ';
				if($average['minutes']) $average_string .= $average['minutes'].' minutes ';
				if($average['seconds']) $average_string .= $average['seconds'].' seconds ';
				$tpl->assign('average_open_call_time', $average_string);
				$tpl->parse('main.open_calls.open_calls_table');
			}else{
				$tpl->assign('open_call_type', $_GET['open_call_type']);
				$tpl->parse('main.open_calls.no_open_calls');
			}
			$tpl->parse('main.open_calls');
			$tpl->parse('main');
			$tpl->out('main');
		}
	break;

    case 'restoreRequest': 
		if($ajax) {
			$restore_full_date_time = $_GET['restore_year']."-".$_GET['restore_month']."-".$_GET['restore_date']." ".$_GET['restore_hour'].":".$_GET['restore_minute'];
			$less_one_month = strtotime("one month ago", $restore_full_date_time);

			if ($_GET['restore_system'] != 'Select Server' && $_GET['restore_path'] != '' && $_GET['restore_filenames'] != '' && $_GET['restore_details'] != '' && $less_one_month < $restore_full_date_time){

			//BEGIN SEND RESTORE REQUEST EMAIL
				if($GLOBALS['DEVELOPMENT']){
					$ToUser = "tgharoutunian";
				}else{
					$sql ="SELECT user_name FROM its_employee_groups,call_log_employee WHERE group_id = 3 AND employee_id = call_log_user_id AND option_id = 2 AND status = 'active'";
					$mail_users = $db->GetAll($sql);
					
					$to_users = '';
					foreach($mail_users as $m_user)
					{
						$to_users .= $m_user['user_name'].'@plymouth.edu, ';
					}//end foreach
					$to_users = trim($to_users,', ');
					
					//$ToUser = "cliff";
				}
				$UserInfo = "User: ".$_GET['caller_first_name']." ".$_GET['caller_last_name']." (".$_GET['caller_user_name'].") has requested a restore\n";
				$caller_last_name = $_GET['caller_last_name'];
				$restore_system = "System: ".$_GET['restore_system']."\n";
				$restore_path = "Path: ".$_GET['restore_path']."\n";
				$restore_filenames = "Filenames: ".$_GET['restore_filenames']."\n";
				if ($_GET['restore_system'] == 'oz'){
					$caller_last_name_letter = ucfirst($caller_last_name{0});
					if ($_GET['caller_role'] == 'student'){ $_GET['caller_role'] = 'students'; }
					$restore_complete_path = "Complete Path:  /".$_GET['caller_role']."/".$caller_last_name_letter."/".$_GET['caller_user_name']."/".$_GET['restore_path']."\n\n";
				}
				$restore_date = "Last Known Good Date/Time: ".$_GET['restore_month'].'/'.$_GET['restore_date'].'/'.$_GET['restore_year']." @ ".$_GET['restore_hour'].':'.$_GET['restore_minute']."\n\n";
				$restore_details = "Additional Details: ".$_GET['restore_details']."\n";
				$message = $UserInfo.$restore_system.$restore_path.$restore_filenames.$restore_complete_path.$restore_date.$restore_details;
				mail($to_users, 'Backup Restore Request', $message, 'From: '.$_SESSION['full_name'].'<'.$_SESSION['username'].'@plymouth.edu>');
				$call_location = $GLOBALS['new_call']->returnCallLoggedFromLocation($_SERVER['REMOTE_ADDR']);
				$_REQUEST['call_log_username'] = $_SESSION['username']; // yours
				$_REQUEST['caller_first_name'] = $_GET['caller_first_name'];
				$_REQUEST['caller_last_name'] = $_GET['caller_last_name'];
				$_REQUEST['caller_user_name'] = $_GET['caller_user_name']; // theirs
				$_REQUEST['call_status'] = 'open';
				$_REQUEST['call_priority'] = 'normal';
				$_REQUEST['tlc_assigned_to'] = $ToUser;
				$_REQUEST['its_assigned_group'] = 3;
				$_REQUEST['problem_details'] = "
				Restore Request for this user.<br/><br/>
				$restore_system<br/>
				$restore_path<br/>
				$restore_filenames<br/>
				$restore_complete_path<br/><br/>
				$restore_date<br/>
				$restore_time<br/>
				$restore_details";
				$_REQUEST['keywords_list'] = 'restoreRequest';
				$GLOBALS['new_call']->addNewCall($_REQUEST, $call_location);
				ob_end_clean();
			//END SEND RESTORE REQUEST EMAIL
				$tpl->parse('main.restore_request.restore_request_complete');
			}else{
				$tpl->parse('main.restore_request.restore_request_error');
				echo $GLOBALS['restore']->restoreRequestFunc($getData=true, $_GET);
			}
			$tpl->parse('main.restore_request');
			$tpl->parse('main');
			$tpl->out('main');
			exit;
		}
	break;

	case 'callHistoryDetails': 
		if($ajax) {
			$call_id = $_GET['call_id'];
			$tpl->assign('this_call_id', $call_id);
			$tpl->assign('this_caller_username', $_GET['caller_user_name']);
			$call_details = $GLOBALS['user']->getCallDetails($call_id);
			if(is_array($call_details['call_log'])){
				$call_date = date("F d, Y", strtotime($call_details['call_log'][0]['call_date']));
				$call_time = date("g:i a", strtotime($call_details['call_log'][0]['call_time']));
				$building_id = getBuildingName($call_details['call_log'][0]['location_building_id']);
				
				$tpl->assign('call_id', $call_details['call_log'][0]['call_id']);

				$details = $call_details['call_log'][0];

				$identifier = PSU::nvl($details['caller_username'], $details['wp_id'], $details['pidm']);
				$tpl->assign('caller', $identifier);
				$tpl->assign('caller_username', $details['caller_username']);
				$tpl->assign('caller_name', $details['caller_first_name']." ".$details['caller_last_name']);
				$tpl->assign('caller_phone_number', $details['caller_phone_number']);
				$tpl->assign('calllog_username', $details['calllog_username']);
				$tpl->assign('call_date_time', $call_date." @ ".$call_time);
				$tpl->assign('keywords', $details['keywords']);
				$tpl->assign('location', $building_id.", ".$details['location_building_room_number']);
				$tpl->assign('call_logged_from', $details['location_call_logged_from']);
				$tpl->parse('main.call_history.call_log_details');
			}

			if(is_array($call_details['call_history'])){
				for($i=0; $i<=sizeOf($call_details['call_history'])-1; $i++){
					$call_date = date("F d, Y", strtotime($call_details['call_history'][$i]['date_assigned']));
					$call_time = date("g:i a", strtotime($call_details['call_history'][$i]['time_assigned']));
					$groupArray = getGroupInfo($call_details['call_history'][$i]['its_assigned_group']);	
					$its_assigned_group = $groupArray[0];
					$priority = $call_details['call_history'][$i]['call_priority'];
					if ($priority == 'normal'){
						$tpl->assign('priority_color', "#55AE3A");
					}else if ($priority == 'high'){
						$tpl->assign('priority_color', "#CD0000");
					}else if ($priority == 'medium'){
						$tpl->assign('priority_color', "#FFFF7E");
					}
					$tpl->assign('updated_by', $call_details['call_history'][$i]['updated_by']);
					$tpl->assign('tlc_assigned_to', $call_details['call_history'][$i]['tlc_assigned_to']);
					$tpl->assign('its_assigned_group', $its_assigned_group);
					$tpl->assign('comments', wordwrap(str_replace('<br />','<br>',nl2br($call_details['call_history'][$i]['comments'])), 50, "<br>"));
					$tpl->assign('call_status', $call_details['call_history'][$i]['call_status']);
					$tpl->assign('priority', ucwords($priority));
					$tpl->assign('call_time', $call_time);
					$tpl->assign('call_date', $call_date);

					$tpl->parse('main.call_history.call_num_assigned.call_history_details');
					$tpl->parse('main.call_history.call_num_assigned');
				}// end for loop
			}// end if
			$tpl->parse('main.call_history');
			$tpl->parse('main');
			$tpl->out('main');
			exit;
		}
	break;

	case 'callHistorySummary': 
		if($ajax) {
			echo $GLOBALS['user']->userCallHistory($_GET['caller']);
			exit;
		}
	break;

	case 'mediaHistoryDetails': 
		if($ajax){
			$media_details = $GLOBALS['user']->getMediaDetails($_GET['media_id']);
			$tpl->assign('media_id', $media_id);
			$tpl->assign('start_date', $media_details['media_info']['start_date'].' @ '.$media_details['media_info']['start_time']);
			$tpl->assign('end_date', $media_details['media_info']['end_date'].' @ '.$media_details['media_info']['end_time']);
			$tpl->assign('memo', $media_details['media_info']['memo']);
			$tpl->assign('location', getBuildingName($media_details['media_info']['building_idx']).' - '.$media_details['media_info']['room']);
			$tpl->assign('request_items', $media_details['media_info']['request_items']);
			for($i=0;$i<count($media_details['media_items']);$i++){
				$tpl->assign('item_id', $media_details['media_items'][$i]['equipment_idx']);
				$tpl->assign('category', $media_details['media_items'][$i]['type']);
				if($i){
					$tpl->parse('main.media_history.media_items.last_media_item');
				}
				$tpl->parse('main.media_history.media_items');
			}
			$tpl->parse('main.media_history');
			$tpl->parse('main');
			$tpl->out('main');
			exit;
		}
	break;

	case 'mediaHistorySummary': 
		if($ajax) {
			echo $GLOBALS['user']->userMediaLoans($_GET['caller_user_name']);
			exit;
		}
	break;

	case 'showFullBlogPost': 
		if($ajax) {
			$Blog_id = $_GET[blog_id];
			$feed = fetch_rss('http://helpdesk.blogs.plymouth.edu/feed');
			$feed = $feed->items[$Blog_id];
			$comments_feed = fetch_rss($feed[link].'feed');
			$comments = $comments_feed->items;
			//prePrint($comments);
			$date = date("l, F jS, Y \@ g:ia", $feed[date_timestamp]);
			$tpl->assign('blog_title', $feed[title]);
			$tpl->assign('blog_link', $feed[link]);
			$tpl->assign('blog_pubdate', $date);
			$tpl->assign('blog_creator', $feed[dc][creator]);
			$tpl->assign('blog_category', $feed[category]);
			$tpl->assign('blog_description', $feed[description]);
			$tpl->assign('blog_encoded', $feed[content][encoded]);
			$tpl->parse('main.blog_post');
			for($i=0;$i<count($comments);$i++){
				$tpl->assign('i', $i+1);
				$tpl->assign('comments_content', $comments[$i][content][encoded]);
				$tpl->assign('comments_pubdate', date("l, F jS, Y \@ g:ia", $comments[$i][date_timestamp]));
				$tpl->parse('main.blog_comments_function.blog_comments');
			}
				$tpl->assign('blog_id', $Blog_id);
				$tpl->assign('tlc_email', $_SESSION['username']."@plymouth.edu");
				$tpl->assign('tlc_full_name', $_SESSION['tlc_full_name']);
			$tpl->parse('main.blog_comments_function');
			$tpl->parse('main');
			$tpl->out('main');
			exit;
		}
	break;

	case 'sendCallerEmail':
		if($ajax){
			$call_id = $_GET['call_id'];
			$its_group = $_GET['its_group'];
			$message = $_GET['message'];
			if($GLOBALS['DEVELOPMENT']){
				$to = $_SESSION['username']."@plymouth.edu";
			}else{
				$to = $_GET['caller_first_name']." ".$_GET['caller_last_name'] . "<".$_GET['user_name']."@plymouth.edu>";
			}
			$from = "Learning Commons <helpdesk@plymouth.edu>";
			$reply_to = "Learning Commons <helpdesk@plymouth.edu>";
			$subject = "Your Helpdesk/Library Request";
			$auto_append = "\r\n\r\n\r\n
			Lamson Learning Commons\r\n
			Plymouth State University\r\n
			603-535-2929\r\n\r\n			
			This message was created by the Learning Commons, if you did not request this email, please reply to this email and explain the situation";
			$message = $message.$auto_append;
			$text = $message;
			$message = preg_replace("/\bhttp:\/\/[\S]+\b/", "<a href=\"$0\">$0</a>", $message);
			$html = nl2br($message);

			$boundary = md5(uniqid(time()));
			$headers = '';
			$headers .= 'To: ' . $to . "\r\n";
			$headers .= 'From: ' . $from . "\r\n";
			$headers .= 'Return-Path: ' . $from . "\r\n";
			$headers .= 'Reply-To: '. $reply_to . "\r\n";
			$headers .= 'Call-ID: '. $call_id . "\r\n";
			$headers .= 'ITS-Group: '. $its_group . "\r\n";
			$headers .= 'MIME-Version: 1.0' ."\r\n";
			$headers .= 'Content-Type: multipart/alternative; boundary="' . $boundary . '"' . "\r\n\r\n";
			$headers .= $text . "\r\n";
			$headers .= '--' . $boundary . "\r\n";
			$headers .= 'Content-Type: text/plain; charset=ISO-8859-1' ."\r\n";
			$headers .= 'Content-Transfer-Encoding: 8bit'. "\r\n\r\n";
			$headers .= $text . "\r\n";
			$headers .= '--' . $boundary . "\r\n";
			$headers .= 'Content-Type: text/HTML; charset=ISO-8859-1' ."\r\n";
			$headers .= 'Content-Transfer-Encoding: 8bit'. "\r\n\r\n";
			$headers .= $html . "\r\n";
			$headers .= '--' . $boundary . "--\r\n";
			mail('',$subject,'',$headers);
			$tpl->parse('main.queueEmailMessage');
			$tpl->parse('main');
			$tpl->out('main');
		}
	break;

	case 'assign_reorder':
		if($ajax){
			$sort_order = $_GET['order'] == 'old' ? 'ASC' : 'DESC';
			$db->Execute("UPDATE call_log_employee SET update_sort = '$sort_order' WHERE user_name = '{$_SESSION['username']}'");

			if($_GET['order'] == 'old'){
				$getOpenCallDetails = $db->GetAll("SELECT * FROM call_log, call_history WHERE call_log.call_id = '{$_GET['call_id']}' AND call_log.call_id = call_history.call_id AND call_log.caller_username = '{$_GET['caller_user_name']}' ORDER BY date_assigned ASC, time_assigned ASC");
			}else{
				$getOpenCallDetails = $db->GetAll("SELECT * FROM call_log, call_history WHERE call_log.call_id = '{$_GET['call_id']}' AND call_log.call_id = call_history.call_id AND call_log.caller_username = '{$_GET['caller_user_name']}' ORDER BY date_assigned DESC, time_assigned DESC");
			}

			foreach ($getOpenCallDetails as $getOpenCallDetailsValue){
				$comments = preg_replace("/[\*]{114}/", "____________________________________________", $getOpenCallDetailsValue['comments']);
				$tpl->assign('call_assignment_history_comments', nl2br(strip_tags($comments)));
				$tpl->assign('call_assignment_history_priority', $getOpenCallDetailsValue['call_priority']);
				$tpl->assign('call_assignment_history_status', $getOpenCallDetailsValue['call_status']);
				$tpl->assign('call_assignment_history_updated', $getOpenCallDetailsValue['updated_by']);
				$tpl->assign('call_assignment_history_date', $getOpenCallDetailsValue['date_assigned']);
				$tpl->assign('call_assignment_history_time', $getOpenCallDetailsValue['time_assigned']);
				$tpl->assign('call_assignment_history_keywords', $getOpenCallDetailsValue['keywords']);
				$tpl->assign('call_assignment_history_assigned_to', $getOpenCallDetailsValue['tlc_assigned_to']);
				$tpl->parse('main.assign_reorder.call_assignment_history');
			}

			$tpl->assign('call_history_id', $getOpenCallDetails[0]['id']);
			$tpl->assign('details_name', "Update Information");
			$tpl->assign('call_assigned_to', $GLOBALS['user']->callAssignedTo($tlc_users_options, $its_group_options, $tlc_assigned_to, $its_assigned_to));
			$tpl->assign('caller_user_name', $_GET['caller_user_name']);
			$tpl->assign('call_id', $_GET['call_id']);

			$tpl->parse('main.assign_reorder');
			$tpl->parse('main');
			$tpl->out('main');
	}
	break;

	case 'change_assign_state':
		if($ajax){
			if($_GET['order'] == 'old'){
				echo "Old-New";
			}else{
				echo "New-Old";
			}
		}
	break;

}

